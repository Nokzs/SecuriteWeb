server:
  port: ${GATEWAY_PORT:8082}
  forward-headers-strategy: framework

app:
  param: ${APP_PARAM_NAME:app}
  cors:
    allowed-origins:
      - "http://front.home.arpa"
      - "http://hotel.internal"
      - "http://localhost:3000"
  redirect:
    default: ${APP_REDIRECT_DEFAULT:http://localhost:3000/}
    apps:
      appA: ${APP_REDIRECT_APPA:http://localhost:3000/}
      appB: ${APP_REDIRECT_APPB:http://localhost:3001/}

spring:
  application:
    name: gateway-bff

  session:
    store-type: redis
    cookie:
      name: ${GATEWAY_SESSION_COOKIE_NAME:MYAPP_SESSION}
      http-only: true
      same-site: ${GATEWAY_SESSION_COOKIE_SAMESITE:LAX}
      secure: ${GATEWAY_SESSION_COOKIE_SECURE:false}

  data:
    redis:
      host: ${REDIS_HOST:redis}
      port: ${REDIS_PORT:6379}

  security:
    oauth2:
      client:
        registration:
          gateway-client:
            provider: monolith
            client-id: ${OAUTH2_CLIENT_ID:gateway-client}
            client-secret: ${OAUTH2_CLIENT_SECRET:secret-secret}
            client-authentication-method: client_secret_post
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            scope: ${OAUTH2_SCOPES:openid,profile,email,offline_access}
        provider:
          monolith:
            authorization-uri: http://back.home.arpa/oauth2/authorize
            token-uri: http://192.168.3.3:8080/oauth2/token
            jwk-set-uri: http://192.168.3.3:8080/oauth2/jwks
            user-info-uri: http://192.168.3.3:8080/userinfo

  cloud:
    gateway:
      server:
        webflux:
          routes:
            - id: appa-api
              uri: ${APPA_BASE_URI:${MONOLITH_BASE_URI:http://backend:8080}}
              predicates:
                - Path=/${APPA_PATH_PREFIX:appA}/api/**
              filters:
                - TokenRelay
                - RewritePath=/${APPA_PATH_PREFIX:appA}/api/(?<segment>.*), /api/${segment}
            - id: appb-api
              uri: ${APPB_BASE_URI:${MONOLITH_BASE_URIB:http://backendb:8080}}
              predicates:
                - Path=/${APPB_PATH_PREFIX:appB}/api/**
              filters:
                - TokenRelay
                - RewritePath=/${APPB_PATH_PREFIX:appB}/api/(?<segment>.*), /api/${segment}

logging:
  level:
    org.springframework.security: DEBUG
    org.springframework.security.oauth2: DEBUG
    org.springframework.web: INFO
    # Pour voir chaque requête qui entre dans la Gateway
    org.springframework.web.server.adapter.HttpWebHandlerAdapter: TRACE
    # Pour voir si la route est trouvée
    org.springframework.cloud.gateway: TRACE
    org.springframework.security.web.server.csrf.CsrfWebFilter: DEBUG
    org.springframework.security.web.server.authorization.AuthorizationWebFilter: DEBUG
